# Runs after a Docker image is built and pushed. Uses workflow_run so the image
# exists in the registry. Scans the image tagged with the short commit SHA
# of the workflow_run head (e.g. sha-abcdef1).
name: Container image scan

on:
  workflow_run:
    workflows: [ "Build and Publish Docker Image" ]
    types: [ completed ]

jobs:
  scan:
    # Only run when the build workflow actually pushed an image (success)
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
      packages: read

    steps:
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image ref
        id: ref
        run: |
          HEAD_SHA="${{ github.event.workflow_run.head_sha }}"
          SHORT_SHA="${HEAD_SHA::7}"

          # Use an immutable tag derived from the workflow_run head SHA (matches docker/metadata-action type=sha,format=short).
          REF="sha-${SHORT_SHA}"
          echo "ref=${REF}" >> "$GITHUB_OUTPUT"
          echo "image=ghcr.io/${{ github.repository }}:${REF}" >> "$GITHUB_OUTPUT"

      - name: Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@master
        env:
          TRIVY_SCANNERS: vuln
        with:
          image-ref: ${{ steps.ref.outputs.image }}
          format: sarif
          output: trivy-results.sarif
          ignore-unfixed: true
          vuln-type: os,library
          scanners: vuln

      - name: Upload Trivy SARIF
        if: hashFiles('trivy-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif

      - name: Run Trivy vulnerability scanner (table)
        uses: aquasecurity/trivy-action@master
        env:
          TRIVY_SCANNERS: vuln
        with:
          image-ref: ${{ steps.ref.outputs.image }}
          format: table
          exit-code: 1
          ignore-unfixed: true
          vuln-type: os,library
          severity: CRITICAL,HIGH,MEDIUM
          scanners: vuln

      - name: Run Grype vulnerability scanner
        uses: anchore/scan-action@v3
        with:
          image: ${{ steps.ref.outputs.image }}
          fail-build: true
          severity-cutoff: high
          output-format: table

      - name: Generate SBOM
        uses: anchore/sbom-action@v0.17.5
        with:
          image: ${{ steps.ref.outputs.image }}
          format: json
          output-file: sbom.json
          upload-artifact: false

      - name: Upload SBOM artifact
        if: hashFiles('sbom.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ steps.ref.outputs.ref }}
          path: sbom.json
